package dev.tigr.ares.fabric.impl.modules.exploit;

import dev.tigr.ares.core.feature.module.Category;
import dev.tigr.ares.core.feature.module.Module;
import dev.tigr.ares.core.setting.Setting;
import dev.tigr.ares.core.setting.settings.EnumSetting;
import dev.tigr.ares.fabric.event.client.PacketEvent;
import dev.tigr.ares.fabric.event.player.DamageBlockEvent;
import dev.tigr.simpleevents.listener.EventHandler;
import dev.tigr.simpleevents.listener.EventListener;
import net.minecraft.block.Blocks;
import net.minecraft.network.packet.c2s.play.HandSwingC2SPacket;
import net.minecraft.network.packet.c2s.play.PlayerActionC2SPacket;
import net.minecraft.util.math.BlockPos;

/**
 * @author Tigermouthbear
 * ported to Fabric by Hoosiers 11/26/20
 */
@Module.Info(name = "NoSwing", description = "Prevents the swing animation for others", category = Category.EXPLOIT)
public class NoSwing extends Module {
    private final Setting<Mode> mode = register(new EnumSetting<>("Mode", Mode.NO_ANIMATION));

    @EventHandler
    public EventListener<PacketEvent.Sent> packetSentEvent = new EventListener<>(event -> {
        if(mode.getValue() == Mode.NO_ANIMATION && event.getPacket() instanceof HandSwingC2SPacket)
            event.setCancelled(true);
    });

    //Migrating away from a forge event will help with porting to Fabric -Hoosiers
    @EventHandler
    public EventListener<DamageBlockEvent> damageBlockEvent = new EventListener<>(event -> {
        if(mode.getValue() != Mode.PACKET_MINE) return;

        if(MC.options.keyAttack.isPressed() && MC.targetedEntity == null) {
            if(canBreakBlock(event.getBlockPos())) {
                MC.player.networkHandler.sendPacket(new PlayerActionC2SPacket(PlayerActionC2SPacket.Action.START_DESTROY_BLOCK, event.getBlockPos(), event.getDirection()));
                MC.player.networkHandler.sendPacket(new PlayerActionC2SPacket(PlayerActionC2SPacket.Action.STOP_DESTROY_BLOCK, event.getBlockPos(), event.getDirection()));
                event.setCancelled(true);
            }
        }
    });

    //we don't want to try to break something that is unbreakable
    private boolean canBreakBlock(BlockPos blockPos) {
        return !(MC.world.getBlockState(blockPos).getBlock() == Blocks.BEDROCK) || !(MC.world.getBlockState(blockPos).getBlock() == Blocks.BARRIER);
    }

    @Override
    public String getInfo() {
        return mode.getValue().name();
    }

    enum Mode {
        NO_ANIMATION, PACKET_MINE
    }
}