package dev.tigr.ares.forge.impl.modules.exploit;

import dev.tigr.ares.core.feature.module.Category;
import dev.tigr.ares.core.feature.module.Module;
import dev.tigr.ares.core.setting.Setting;
import dev.tigr.ares.core.setting.settings.EnumSetting;
import dev.tigr.ares.forge.event.events.player.PacketEvent;
import dev.tigr.simpleevents.listener.EventHandler;
import dev.tigr.simpleevents.listener.EventListener;
import net.minecraft.network.play.client.CPacketAnimation;
import net.minecraft.network.play.client.CPacketPlayerDigging;
import net.minecraft.util.EnumFacing;
import net.minecraft.util.math.BlockPos;
import net.minecraftforge.client.event.MouseEvent;

/**
 * @author Tigermouthbear
 */
@Module.Info(name = "NoSwing", description = "Prevents the swing animation for others", category = Category.EXPLOIT)
public class NoSwing extends Module {
    private final Setting<Mode> mode = register(new EnumSetting<>("Mode", Mode.NO_ANIMATION));
    
    @EventHandler
    public EventListener<PacketEvent.Sent> packetSentEvent = new EventListener<>(event -> {
        if(mode.getValue() == Mode.NO_ANIMATION && event.getPacket() instanceof CPacketAnimation)
            event.setCancelled(true);
    });
    
    @EventHandler
    public EventListener<MouseEvent> mouseClickEvent = new EventListener<>(event -> {
        if(!(mode.getValue() == Mode.PACKET_MINE)) return;

        if(event.getButton() == 0 && MC.objectMouseOver.entityHit == null) {
            BlockPos block = MC.objectMouseOver.getBlockPos();
            MC.player.connection.sendPacket(new CPacketPlayerDigging(CPacketPlayerDigging.Action.START_DESTROY_BLOCK, block, EnumFacing.UP));
            MC.player.connection.sendPacket(new CPacketPlayerDigging(CPacketPlayerDigging.Action.STOP_DESTROY_BLOCK, block, EnumFacing.UP));
            event.setCanceled(true);
        }

        if(event.getButton() == 0 && MC.objectMouseOver.entityHit != null) {
            MC.playerController.attackEntity(MC.player, MC.objectMouseOver.entityHit);
            event.setCanceled(true);
        }
    });

    @Override
    public String getInfo() {
        return mode.getValue().name();
    }

    enum Mode {
        NO_ANIMATION, PACKET_MINE
    }
}
